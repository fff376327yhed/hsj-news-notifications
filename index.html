<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”” ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ë„êµ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .step {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .step h3 {
            color: #2d3748;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 12px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-test {
            background: #48bb78;
            color: white;
        }
        
        .btn-test:hover {
            background: #38a169;
            transform: translateY(-2px);
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
            display: none;
        }
        
        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
            display: block;
        }
        
        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
            display: block;
        }
        
        .status.info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
            display: block;
        }
        
        .info-box {
            background: #edf2f7;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            color: #4a5568;
            line-height: 1.6;
        }
        
        code {
            background: #2d3748;
            color: #48bb78;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” ë°±ê·¸ë¼ìš´ë“œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h1>
        <p class="subtitle">ì›¹ì‚¬ì´íŠ¸ ë°–ì—ì„œë„ ì•Œë¦¼ì´ ì˜¤ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”</p>
        
        <div class="step">
            <h3>
                <span class="step-number">1</span>
                ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
            </h3>
            <p style="color: #718096; font-size: 14px; margin-bottom: 12px;">
                ë¸Œë¼ìš°ì €ì—ì„œ ì•Œë¦¼ì„ í‘œì‹œí•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.
            </p>
            <button class="btn-primary" onclick="requestPermission()">
                ğŸ“± ì•Œë¦¼ ê¶Œí•œ í—ˆìš©í•˜ê¸°
            </button>
            <div id="permissionStatus" class="status"></div>
        </div>
        
        <div class="step">
            <h3>
                <span class="step-number">2</span>
                FCM í† í° ë“±ë¡
            </h3>
            <p style="color: #718096; font-size: 14px; margin-bottom: 12px;">
                Firebase Cloud Messaging í† í°ì„ ìƒì„±í•˜ê³  ë“±ë¡í•©ë‹ˆë‹¤.
            </p>
            <button class="btn-primary" onclick="registerToken()">
                ğŸ”‘ í† í° ë“±ë¡í•˜ê¸°
            </button>
            <div id="tokenStatus" class="status"></div>
        </div>
        
        <div class="step">
            <h3>
                <span class="step-number">3</span>
                í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡
            </h3>
            <p style="color: #718096; font-size: 14px; margin-bottom: 12px;">
                10ì´ˆ í›„ì— í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤. <strong>ì´ íƒ­ì„ ë‹«ê±°ë‚˜ ìµœì†Œí™”í•˜ì„¸ìš”!</strong>
            </p>
            <button class="btn-test" onclick="sendTestNotification()">
                ğŸš€ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë³´ë‚´ê¸° (10ì´ˆ ëŒ€ê¸°)
            </button>
            <div id="testStatus" class="status"></div>
        </div>
        
        <div class="info-box">
            <strong>ğŸ’¡ í…ŒìŠ¤íŠ¸ ë°©ë²•:</strong><br>
            1. ìœ„ 3ë‹¨ê³„ë¥¼ ìˆœì„œëŒ€ë¡œ ì™„ë£Œí•˜ì„¸ìš”<br>
            2. "í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë³´ë‚´ê¸°" ë²„íŠ¼ í´ë¦­<br>
            3. ì¦‰ì‹œ ì´ <strong>ë¸Œë¼ìš°ì € íƒ­ì„ ë‹«ê±°ë‚˜ ë‹¤ë¥¸ ì•±ìœ¼ë¡œ ì „í™˜</strong>í•˜ì„¸ìš”<br>
            4. 10ì´ˆ í›„ ì•Œë¦¼ì´ ì˜¤ë©´ ì„±ê³µ! ğŸ‰<br><br>
            
            <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong><br>
            â€¢ íƒ­ì„ ì—´ì–´ë‘ë©´ ë°±ê·¸ë¼ìš´ë“œ ì•Œë¦¼ì´ ì•„ë‹Œ ì¼ë°˜ ì•Œë¦¼ì´ ì˜µë‹ˆë‹¤<br>
            â€¢ iOS SafariëŠ” ë°±ê·¸ë¼ìš´ë“œ ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤<br>
            â€¢ Chrome, Edge, Firefoxì—ì„œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp({
            apiKey: "AIzaSyDgooYtVr8-jm15-fx_WvGLCDxonLpNPuU",
            authDomain: "hsj-news.firebaseapp.com",
            databaseURL: "https://hsj-news-default-rtdb.firebaseio.com",
            projectId: "hsj-news",
            storageBucket: "hsj-news.firebasestorage.app",
            messagingSenderId: "437842430700",
            appId: "1:437842430700:web:e3822bde4cfecdc04633c9"
        });
        
        const messaging = firebase.messaging();
        const db = firebase.database();
        
        let currentToken = null;
        
        // 1. ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        async function requestPermission() {
            const statusDiv = document.getElementById('permissionStatus');
            
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = 'âœ… ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!';
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = 'âŒ ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
            }
        }
        
        // 2. FCM í† í° ë“±ë¡
        async function registerToken() {
            const statusDiv = document.getElementById('tokenStatus');
            
            try {
                statusDiv.className = 'status info';
                statusDiv.textContent = 'â³ Service Worker ë“±ë¡ ì¤‘...';
                
                // Service Worker ë“±ë¡
                const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js', {
                    scope: '/',
                    updateViaCache: 'none'
                });
                
                await navigator.serviceWorker.ready;
                
                statusDiv.textContent = 'â³ FCM í† í° ë°œê¸‰ ì¤‘...';
                
                // FCM í† í° ë°œê¸‰
                currentToken = await messaging.getToken({
                    serviceWorkerRegistration: registration,
                    vapidKey: "BFJBBAv_qOw_aklFbE89r_cuCArMJkMK56Ryj9M1l1a3qv8CuHCJ-fKALtOn4taF7Pjwo2bjfoOuewEKBqRBtCo"
                });
                
                // í…ŒìŠ¤íŠ¸ìš© ì‚¬ìš©ì IDë¡œ ì €ì¥
                const testUserId = 'test_user_' + Date.now();
                await db.ref(`users/${testUserId}/fcmTokens/test`).set({
                    token: currentToken,
                    updatedAt: Date.now(),
                    browser: navigator.userAgent.substring(0, 100),
                    platform: navigator.platform
                });
                
                // ë¡œì»¬ì— ì €ì¥
                localStorage.setItem('testUserId', testUserId);
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `âœ… í† í° ë“±ë¡ ì™„ë£Œ!<br><code>${currentToken.substring(0, 30)}...</code>`;
                
                // í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ
                messaging.onMessage((payload) => {
                    console.log('í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€:', payload);
                    new Notification(payload.notification.title, {
                        body: payload.notification.body,
                        icon: '/favicon/favicon-32x32.png'
                    });
                });
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                console.error('í† í° ë“±ë¡ ì˜¤ë¥˜:', error);
            }
        }
        
        // 3. í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡
        async function sendTestNotification() {
            const statusDiv = document.getElementById('testStatus');
            const testUserId = localStorage.getItem('testUserId');
            
            if (!testUserId || !currentToken) {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ ë¨¼ì € ìœ„ì˜ 1, 2ë‹¨ê³„ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”!';
                return;
            }
            
            try {
                // ì•Œë¦¼ ë°ì´í„° ì €ì¥
                const notificationId = 'test_' + Date.now();
                await db.ref(`notifications/${testUserId}/${notificationId}`).set({
                    title: 'ğŸ‰ ë°±ê·¸ë¼ìš´ë“œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸',
                    text: 'ì„±ê³µ! ì›¹ì‚¬ì´íŠ¸ë¥¼ ë‹«ì•„ë„ ì•Œë¦¼ì´ ì™”ìŠµë‹ˆë‹¤!',
                    articleId: '',
                    timestamp: Date.now(),
                    read: false,
                    pushed: false,
                    type: 'test'
                });
                
                statusDiv.className = 'status info';
                statusDiv.innerHTML = `
                    â° 10ì´ˆ í›„ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤!<br>
                    <strong>ì§€ê¸ˆ ë°”ë¡œ ì´ íƒ­ì„ ë‹«ê±°ë‚˜ ë‹¤ë¥¸ ì•±ìœ¼ë¡œ ì „í™˜í•˜ì„¸ìš”!</strong><br>
                    <span style="font-size: 12px; opacity: 0.8;">GitHub Actionsê°€ 5ë¶„ë§ˆë‹¤ ì•Œë¦¼ì„ í™•ì¸í•©ë‹ˆë‹¤.</span>
                `;
                
                // 10ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´
                let countdown = 10;
                const timer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        statusDiv.innerHTML = `
                            â° ${countdown}ì´ˆ í›„ ì•Œë¦¼ ì „ì†¡...<br>
                            <strong>íƒ­ì„ ë‹«ìœ¼ì„¸ìš”!</strong>
                        `;
                    } else {
                        clearInterval(timer);
                        statusDiv.className = 'status success';
                        statusDiv.innerHTML = `
                            âœ… ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!<br>
                            ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì•Œë¦¼ì„ í™•ì¸í•˜ì„¸ìš” (ìµœëŒ€ 5ë¶„ ì†Œìš”)
                        `;
                    }
                }, 1000);
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                console.error('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜:', error);
            }
        }
    </script>
</body>
</html>
